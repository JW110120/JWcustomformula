一、目标与范围
- 目标：实现 Photoshop UXP 面板“自定义混合模式”，允许：
  1. 选择基底图层与混合图层，从 Photoshop 拿到两者像素；
  2. 在面板中输入/选择自定义公式；
  3. 计算结果并将像素写回到新建图层。
- 范围：
  - UI：顶部图层选择；中部“公式预设/新公式”切换；底部“保存/删除/应用”。
  - 数据：本地持久化保存公式预设（随插件重启可加载）。
  - 主题：适配不同主题，依赖 `theme.ts` 。
  - 规范：遵循 Spectrum（UXP 内置 sp-* 组件）。

二、可行性分析
1. 像素读写可行性
- UXP/PS 环境提供读取与写入像素的能力（你计划书中提及 imaging API 的 getPixels/putPixels）。在目标最小版本（manifest 写明 minVersion 23.0.0）下，可通过：
  - 从指定图层渲染/提取像素（RGBA 8-bit）；
  - 将计算结果写入新建的像素图层。
- 注意点：
  - 某些图层类型（文字、形状、智能对象、调整图层）需先以当前文档设置渲染为位图再拿像素（我们在实现里统一走“渲染成像素”的通道，避免类型分歧），所以如果用户选择了这些非位图图层，可以复制一份作为临时图层，并通过batchplay进行栅格化处理。获取像素数据后可以直接删除。
  - 目前以 8-bit/channel、sRGB 假设为最稳妥路径；非 8-bit 或非 RGB 文档我们会做降级提示或自动转换策略（见“风险与应对”）。

2. 自定义公式执行可行性
- manifest 已声明 "allowCodeGenerationFromStrings": true，允许安全受控地从字符串构建表达式。
- 为避免直接 eval 带来的安全风险，以及减少不可控的 API 访问，我们将构建“受限表达式求值器”：
  - 仅开放有限运算符与内置函数（+ - * / % () min max clamp pow abs floor ceil sqrt exp log mix step smoothstep 等）；
  - 仅开放受控变量（基底/混合图层的 r,g,b,a 通道）；
  - 禁止访问全局对象、原型链以及任何 I/O。
- 性能方面，公式为逐像素计算，需控制在 TypedArray 上高效循环与分块处理，避免内存峰值过高（详见“性能设计”）。

3.  UI 与主题可行性
- 采用 UXP 内置 Spectrum Web Components（sp-button, sp-radio-group, sp-picker, sp-textfield 等）满足规范。
- React 作为壳承载 custom elements 没问题（React 18 对自定义元素友好）。事件绑定将以 onChange/自定义事件桥接。
- 主题适配：利用 UXP 主题切换事件 + 现有 `theme.ts` 中暴露的主题变量，设置 CSS variables，确保深浅主题一致性。

4.  预设持久化可行性
- 使用 UXP 的本地文件系统数据目录进行持久化（如 dataFolder 内创建 formulas.json 或 formulas.js）。
- 启动时读取，面板中加载到 sp-picker；保存/删除操作更新该文件。
- 文件结构建议 JSON：{ version, items: [{ id, name, formula, createdAt }] }，便于扩展与校验。

5. 构建与运行可行性
- 已配置 webpack、tsconfig、manifest、package.json；入口是 `index.tsx` ，主容器是 `MainContainer.tsx` 。
- 已在终端运行 yarn watch 自动编译，后续生成代码避免再次编译。


三、风险与应对
- 颜色空间与位深：
  - 风险：文档可能是 16/32-bit、CMYK/灰度或带有不同色彩配置导致像素读写与计算偏差。
  - 应对：第一阶段仅支持 8-bit RGB 文档；其余情况提示用户先转换，或在读取时自动以文档当前设置渲染到 8-bit RGBA 缓冲（显式提示“结果以 8-bit sRGB 进行计算”）。
- 大尺寸图像内存与性能：
  - 风险：一次性读取/计算/写回超大像素会内存飙升与 UI 卡顿。
  - 应对：块处理（如每次处理 2048x2048 或按 16MB chunk），并在 executeAsModal 内批处理；UI 端显示进度。
- 图层不可直接拿像素：
  - 风险：调整图层/智能对象/矢量图层直接读像素不可行。
  - 应对：用户选择了这些非位图图层，可以复制一份作为临时图层，并通过batchplay进行栅格化处理。获取像素数据后可以直接删除临时图层。
- 公式错误、无穷/NaN：
  - 风险：用户输入错误（如除 0、未定义变量）导致崩溃或黑图。
  - 应对：预解析与静态校验；运行时 clamp 到 [0,1]；出错给出具体报错行列与示例。
- 权限弹窗与文件读写失败：
  - 风险：首次访问 dataFolder 会触发授权；偶发写入失败。
  - 应对：在用户触发“保存”时引导授权；写入带重试（指数退避），直到成功或用户取消。


四、公式设计与约束
- 变量：
  - 基底：rb, gb, bb, ab（0..1）
  - 混合：rs, gs, bs, as（0..1）
- 返回结果：
  - 每个通道分别输出（R/G/B），Alpha 默认为 as 或用户可选策略（如保持基底 ab）。
- 支持函数/操作：
  - 基础：+ - * / % ()，比较 < > <= >= == !=，三元 ? :
  - 数学：abs, min, max, clamp(x, lo, hi), pow, sqrt, exp, log, floor, ceil, round, mix(a,b,t), step(edge,x), smoothstep(e0,e1,x)
  - 颜色工具：lum(r,g,b)=0.299 r+0.587 g+0.114*b，saturate(x)=clamp(x,0,1)
- 风格：
  - 每个通道可独立表达，如：
    R: clamp(rb + rs - rb rs, 0, 1)
    G: clamp(gb + gs - gb gs, 0, 1)
    B: clamp(bb + bs - bb*bs, 0, 1)
- 预设初始内置高频混合模式：
  - 正常混合：R/G/B=rs
  - 正片叠底：rb*rs
  - 滤色：rb + rs - rb*rs
  - 叠加：rb<0.5 ? 2 rb rs : 1 - 2*(1-rb)*(1-rs)
- 校验：
  - 公式解析前语法检查；变量/函数白名单校验；执行时异常捕获与行列提示。

五、性能设计
- 读取：一次性获取两个图层的 RGBA Uint8ClampedArray（或直接渲染为 ImageData）。
- 归一化：在计算环节使用 Float32Array（0..1）；避免重复分配。
- 分块：按固定像素块处理，避免单次占用过多内存。
- 写回：将计算结果转回 Uint8ClampedArray 并 putPixels；尽量减少中间拷贝。
- 线程：UXP 目前主线程模型为主；我们在 executeAsModal 中短批次执行并让出主循环，避免长阻塞。
- 防护：避免在循环中做正则、字符串拼接、动态函数创建等高强度操作；公式编译仅一次，之后重复复用。

六、UI/交互设计
- 顶部区域：
  - 两个 sp-picker：基底图层、混合图层。加载当前文档的可见图层列表（名称+ID），并自动随文档/图层变化更新。
  - 可选：显示缩略图（后续迭代）。
- 中间区域：
  - sp-radio-group：模式=“公式预设”/“新公式”。
  - 选“公式预设”：显示 sp-picker（下拉），列出本地已保存预设；选中后预览公式简短摘要。
  - 选“新公式”：显示 sp-textfield（多行），输入自定义公式（支持每通道分行或统一表达，提供模板与变量提示）。
- 底部区域：
  - 保存：仅在“新公式”启用；点击后写入本地文件并刷新预设列表。
  - 删除：仅在“公式预设”启用；点击后删除选中预设并刷新列表。
  - 应用：读取两图层像素 → 计算 → 新建图层 → putPixels；显示进度与耗时。
  - 错误区：集中展示语法错误/执行报错/文档不匹配等提示。

七、状态管理与模块划分
- 组件层（React）：
  - `MainContainer.tsx` ：负责 UI 编排与交互。
  - Hooks：useLayers、usePresets、useFormulaEngine、useTheming。
- 服务层：
  - imagingService：封装 getPixels/putPixels、分块处理、文档/图层校验。
  - presetService：封装读取/写入 formulas.json，带重试。
  - formulaEngine：解析/编译/执行（受限环境，AST 或受控 Function）。
  - psBridge：与 Photoshop 通信（获取文档/图层列表、监听变更、executeAsModal 封装）。
- 样式层：
  - 主题变量来自 `theme.ts` ，结合 Spectrum token。
  - 组件样式：使用 sp-* 类名，避免全局污染。
  - 在styles文件夹下创建一个formula.css文件，用于定义公式相关的样式。
  - 项目字体使用fonts文件中的SourceHanSansCN-Normal.otf。
- 数据层：
  - 公式数据：存储在 `formulas.json` 中，每个公式包含 id、name、formula（各通道表达式）、createdAt。
  - 状态管理：使用 React Context 或状态管理库（如 Redux），管理全局状态（如选中图层、当前公式、错误信息）。

八、数据与文件持久化设计
- 文件位置：插件 dataFolder 下的 formulas.json（如不存在则创建并写入默认预设）。
- 结构：
  {
  "version": 1,
  "items": [
  { "id": "uuid", "name": "叠加", "formula": { "r": "...", "g": "...", "b": "..." }, "createdAt": 1710000000000 }
  ]
  }
- 读写策略：
  - 启动时读取；校验版本与结构，不合法则重建并备份旧文件。
  - 写入失败重试，直到成功或用户取消。

九、兼容性与限制
- 首发仅支持：
  - RGB 8-bit 文档；
  - 不考虑多通道/专色；
  - 只处理可见区域像素（后续可加“仅处理选区”）。

十、测试计划
- 单元测试：
  - formulaEngine：合法/非法表达式、边界值、函数正确性。
  - presetService：读写、损坏文件修复。
- 集成测试：
  - 小图（512x512）常见预设对比；
  - 大图（>6000px）内存与耗时；
  - 文档/图层切换事件正确刷新。
- 回归：
  - 主题切换；
  - 权限弹窗流程；
  - 断电/写入中断的恢复。

十一、里程碑与实施步骤
- M1 基础框架与 UI 骨架（Top/Center/Bottom 三区，静态交互）
- M2 预设持久化（加载/保存/删除）
- M3 像素通道打通（两图层→像素缓冲→新图层写回，跑通“正常”预设）
- M4 公式引擎（受限表达式、预设内置、错误提示）
- M5 性能与稳定性（分块处理、进度显示、异常处理）
- M6 打磨与适配（主题细节、边界场景、UI 反馈）

十二、个人偏好问题
1.公式语法你更倾向哪种？
- 单表达式同时返回三通道（如返回 [r,g,b] 结构）
- 未来考虑增加每通道分行（R/G/B 各一行）的选项，目前暂不考虑。

2.Alpha 通道如何处理？
- Alpha通道作为一个独立的通道，与RGB通道并行处理。
- 当用户选择背景图层时需要注意，背景图层只有RGB通道，所以对于getpixels获取的数据而言，需要为背景图层增加一个alpha = 255的通道。
- 当用户选择了一个完全透明图层时，透明图层只有alpha通道，所以对于getpixels获取的数据而言，需要将RGB通道设为0，alpha通道设为255。

3.非 8-bit RGB 文档如何处理？
- 自动将渲染缓冲转换到 8-bit 计算（提示可能有色差）；

4.暂不增加对选区应用的开关。

5.预设文件接受使用 dataFolder/formulas.json。

6.为我增加导入/导出预设（JSON）功能，便于跨设备共享。

